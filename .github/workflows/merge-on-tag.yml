name: Merge to Main on Tag

on:
  push:
    tags:
      - "release*"

jobs:
  merge-to-main:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate tag is on dev branch
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          COMMIT_SHA=$(git rev-list -n 1 $TAG_NAME 2>/dev/null || echo "")
          
          if [ -z "$COMMIT_SHA" ]; then
            echo "Error: Tag $TAG_NAME does not point to a valid commit"
            exit 1
          fi
          
          if ! git show-ref --verify --quiet refs/remotes/origin/dev; then
            echo "Error: dev branch does not exist"
            exit 1
          fi
          
          if ! git branch -r --contains $COMMIT_SHA | grep -q "origin/dev"; then
            echo "Error: Tag $TAG_NAME is not on dev branch. Release tags can only be created from dev branch."
            exit 1
          fi

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge dev to main
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          COMMIT_SHA=$(git rev-list -n 1 $TAG_NAME)
          
          git checkout main
          git pull origin main
          git merge $COMMIT_SHA -m "Merge dev to main (triggered by tag: $TAG_NAME)" || {
            echo "Merge conflict detected. Please resolve manually."
            exit 1
          }
          
          git push origin main
